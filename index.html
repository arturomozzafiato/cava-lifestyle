<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>CAVA Lifestyle â€“ Demo</title>
<link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Manrope:wght@600;800&display=swap" rel="stylesheet">
<style>
  :root{
    --glass-fill: rgba(255,255,255,.06);
    --glass-border: rgba(255,255,255,.12);
    --text: #f8fafc;
    --text-dim: rgba(248,250,252,.72);
    --shadow: 0 10px 40px -10px rgba(0,0,0,.5);
    --accent: #34d399;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    color:var(--text);
    font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji",sans-serif;
    background: radial-gradient(1200px 800px at 20% -10%, rgba(255,255,255,.08), transparent),
                linear-gradient(135deg,#F4A261,#E76F51,#8D4D3A); /* Terracotta Court default */
    background-size: 200% 200%;
    animation: pan 22s linear infinite;
  }
  @keyframes pan{0%{background-position:0% 0%}50%{background-position:100% 100%}100%{background-position:0% 0%}}
  .wrap{max-width:420px;margin:0 auto;padding:16px 16px 100px}
  .header{
    position:sticky;top:0;z-index:10;
    backdrop-filter: blur(14px);
    background: rgba(6,7,10,.35);
    border-bottom:1px solid var(--glass-border);
  }
  .bar{display:flex;align-items:center;gap:12px;padding:12px 16px}
  .badge{margin-left:auto;font-size:12px;background:rgba(16,185,129,.18);color:#A7F3D0;padding:6px 10px;border-radius:999px}
  .btn{
    appearance:none;border:0;cursor:pointer;
    background:#fff;color:#0b0f14;
    border-radius:12px;padding:10px 14px;font-weight:700;box-shadow:var(--shadow);
  }
  .btn.ghost{background:transparent;color:var(--text);border:1px solid var(--glass-border);box-shadow:none}
  .btn.small{padding:8px 10px;font-size:12px;border-radius:10px}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .card{
    border:1px solid var(--glass-border);
    background:var(--glass-fill);
    backdrop-filter: blur(18px);
    border-radius:24px; padding:14px; box-shadow:var(--shadow)
  }
  .hero{border-radius:20px;overflow:hidden;border:1px solid var(--glass-border)}
  .hero img{display:block;width:100%;height:180px;object-fit:cover;opacity:.85}
  .muted{color:var(--text-dim);font-size:12px}
  .row{display:flex;align-items:center;justify-content:space-between;gap:12px}
  .tags{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}
  .tag{
    font-size:11px;padding:4px 8px;border-radius:999px;border:1px solid var(--glass-border);background:rgba(255,255,255,.08)
  }
  .tag.disliked{border-color:#fb7185;color:#fecdd3;background:rgba(251,113,133,.15)}
  .nav{
    position:fixed;left:0;right:0;bottom:16px;z-index:20;
    display:flex;justify-content:center;pointer-events:none;
  }
  .nav_inner{
    pointer-events:auto;
    display:grid;grid-template-columns:repeat(5,1fr);gap:4px;
    max-width:420px; margin:0 16px; padding:8px;
    border-radius:20px; backdrop-filter: blur(16px);
    background:rgba(0,0,0,.4); border:1px solid var(--glass-border)
  }
  .nav_btn{
    display:flex;flex-direction:column;align-items:center;gap:4px;
    padding:8px;border-radius:12px;cursor:pointer;font-size:11px;border:0;background:transparent;color:var(--text);
  }
  .nav_btn.active{background:rgba(255,255,255,.1);font-weight:600}
  .stamp{display:grid;place-items:center;border:1px solid var(--glass-border);border-radius:16px;padding:16px;background:rgba(255,255,255,.06)}
  .theme{margin-left:auto}
  .hidden{display:none}
  .counter{color:#fde68a}
  /* modal */
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);display:grid;place-items:end;padding:16px;z-index:50}
  .sheet{width:100%;max-width:420px;border:1px solid var(--glass-border);background:rgba(17,24,39,.9);backdrop-filter: blur(20px);border-radius:24px;padding:16px}
  canvas{background:#0b0f14;border:1px solid rgba(255,255,255,.2);border-radius:8px}
  /* tiny icon circles for nav */
  .dot{width:8px;height:8px;background:#fff;border-radius:999px;opacity:.9}
</style>
</head>
<body>
  <div class="header">
    <div class="bar">
      <div style="font-size:22px">ðŸ¥™</div>
      <div>
        <div style="font:800 18px Manrope,Inter">CAVA Lifestyle</div>
        <div class="muted">Mediterranean Â· Fast Â· Flavorful Â· Real</div>
      </div>
      <button id="themeBtn" class="btn small theme">Terracotta</button>
      <div id="points" class="badge">0 pts</div>
    </div>
  </div>

  <div class="wrap">
    <!-- HOME -->
    <div id="tab-home">
      <div class="card hero" id="labsHero">
        <img id="seasonImg" alt="">
        <div style="padding:12px">
          <div class="muted">Next Labs Drop</div>
          <div style="font:800 20px Manrope,Inter" id="seasonTitle">Summer in Greece</div>
          <div class="muted"><span class="counter" id="countdown">â€”</span> â€¢ <span id="pairings"></span></div>
          <div style="margin-top:10px;display:flex;gap:8px">
            <button class="btn small" id="trySpecial">Try todayâ€™s special</button>
            <button class="btn small ghost" id="goSeason">Explore season</button>
          </div>
        </div>
      </div>

      <div class="card" id="pickCard" style="margin-top:12px">
        <div class="row">
          <div>
            <div class="muted">Todayâ€™s pick for you</div>
            <div id="pickName" style="font-weight:700">â€”</div>
            <div class="muted" id="pickMeta">â€”</div>
          </div>
          <img id="pickImg" src="" alt="" style="width:90px;height:90px;object-fit:cover;border-radius:14px;border:1px solid var(--glass-border)">
        </div>
        <div class="row" style="margin-top:10px">
          <div id="pickPrice" style="color:#bbf7d0;font-weight:700">$â€”</div>
          <div style="display:flex;gap:8px">
            <button class="btn small" id="orderPick">Order</button>
            <button class="btn small ghost" id="openPass">Pickup Pass</button>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px"><div>ðŸŒ¿</div><div style="font-weight:700">Pantry add-ons</div></div>
        <div id="pantryChoices" class="tags"></div>
        <div id="pantrySelected" class="muted" style="margin-top:6px"></div>
      </div>
    </div>

    <!-- SEASON -->
    <div id="tab-season" class="hidden">
      <div class="card hero">
        <img id="seasonImg2" alt="">
      </div>
      <div class="card" style="margin-top:12px">
        <div class="muted">Story</div>
        <div id="seasonStory" style="margin-top:4px">â€”</div>
        <div class="muted" style="margin-top:6px">Pairings: <span id="seasonPairs">â€”</span></div>
        <div style="margin-top:10px;display:flex;gap:8px">
          <button class="btn small" id="seasonTry">Try special</button>
          <button class="btn small ghost" id="seasonNext">Next theme</button>
        </div>
      </div>
    </div>

    <!-- EXPLORE -->
    <div id="tab-explore" class="hidden"></div>

    <!-- JOURNEY -->
    <div id="tab-journey" class="hidden">
      <div class="card">
        <div style="font-weight:700;margin-bottom:6px">Taste Journey</div>
        <div class="muted" style="margin-bottom:8px">Collect all three regions to unlock a bonus.</div>
        <div class="grid2">
          <div class="stamp"><div id="stamp-greece" style="font-size:24px">â¬œ</div><div class="muted">Greece</div></div>
          <div class="stamp"><div id="stamp-levant" style="font-size:24px">â¬œ</div><div class="muted">Levant</div></div>
          <div class="stamp"><div id="stamp-maghreb" style="font-size:24px">â¬œ</div><div class="muted">Maghreb</div></div>
          <div class="stamp"><div class="muted">Reward</div><div class="muted">+100 pts when complete</div></div>
        </div>
        <button class="btn" style="margin-top:12px" id="redeem">Redeem Journey</button>
      </div>
    </div>

    <!-- PROFILE -->
    <div id="tab-profile" class="hidden">
      <div class="card">
        <div style="font-weight:700;margin-bottom:6px">Your preferences</div>
        <label class="row" style="padding:6px 0"><span>Vegetarian</span><input type="checkbox" id="prefVeg"></label>
        <label class="row" style="padding:6px 0"><span>Like it spicy</span><input type="checkbox" id="prefSpicy"></label>
        <div class="row" style="padding:6px 0">
          <span>Budget</span>
          <select id="prefBudget" style="background:rgba(255,255,255,.08);color:var(--text);border:1px solid var(--glass-border);border-radius:8px;padding:6px 8px">
            <option value="low">Low</option><option value="medium">Medium</option><option value="high">High</option>
          </select>
        </div>
        <div class="muted">Tip: mark dislikes on Explore by tapping tags.</div>
      </div>
      <div class="card" style="margin-top:12px">
        <div style="font-weight:700;margin-bottom:6px">History</div>
        <ul id="history" class="muted" style="padding-left:18px;margin:0"></ul>
      </div>
      <div class="card" style="margin-top:12px">
        <button class="btn ghost" id="reset">Reset demo data</button>
      </div>
    </div>
  </div>

  <!-- BOTTOM NAV -->
  <div class="nav">
    <div class="nav_inner">
      <button class="nav_btn active" data-tab="home"><div class="dot"></div>Home</button>
      <button class="nav_btn" data-tab="season"><div class="dot"></div>Season</button>
      <button class="nav_btn" data-tab="explore"><div class="dot"></div>Explore</button>
      <button class="nav_btn" data-tab="journey"><div class="dot"></div>Journey</button>
      <button class="nav_btn" data-tab="profile"><div class="dot"></div>Profile</button>
    </div>
  </div>

  <!-- PICKUP PASS MODAL -->
  <div id="passOverlay" class="overlay hidden">
    <div class="sheet">
      <div class="row" style="margin-bottom:8px"><div style="font-weight:700">Pickup Pass</div><button class="btn small ghost" id="closePass">Close</button></div>
      <div class="row">
        <canvas id="qr" width="120" height="120"></canvas>
        <div>
          <div class="muted">Dynamic PIN</div>
          <div id="pin" style="letter-spacing:4px;font:800 28px Manrope,Inter">â€”</div>
          <div class="muted">Refresh in <span id="refresh">â€”</span>s</div>
          <div class="muted" style="margin-top:8px">Show this at pickup. Staff can scan the code or enter PIN.</div>
        </div>
      </div>
      <div class="row" style="margin-top:12px">
        <button id="copyPIN" class="btn small">Copy PIN</button>
        <button id="simulateScan" class="btn small ghost">Simulate scan</button>
      </div>
    </div>
  </div>

<script>
/* ---------- Data ---------- */
const IMAGES = {
  greece: "https://images.unsplash.com/photo-1543353071-087092ec393a?q=80&w=1600&auto=format&fit=crop",
  levant: "https://images.unsplash.com/photo-1496116218417-1a781b1c416c?q=80&w=1600&auto=format&fit=crop",
  maghreb: "https://images.unsplash.com/photo-1505577058444-a3dab90d4253?q=80&w=1600&auto=format&fit=crop",
  pita: "https://images.unsplash.com/photo-1589301760014-d929f3979dbc?q=80&w=1600&auto=format&fit=crop",
  bowl: "https://images.unsplash.com/photo-1547592166-23ac45744acd?q=80&w=1600&auto=format&fit=crop",
  mezze: "https://images.unsplash.com/photo-1604908554007-1688f52b0b43?q=80&w=1600&auto=format&fit=crop",
};
const MENU = [
  { id:"1", name:"Harissa Chicken Pita", type:"handheld", region:"Levant", spicy:true, vegetarian:false, calories:610, price:10.95, image:IMAGES.pita, tags:["protein","harissa","pita"] },
  { id:"2", name:"Mediterranean Greens Bowl", type:"bowl", region:"Greece", spicy:false, vegetarian:true, calories:520, price:10.45, image:IMAGES.bowl, tags:["greens","feta","tahini"] },
  { id:"3", name:"Lamb Meatball Plate", type:"plate", region:"Levant", spicy:false, vegetarian:false, calories:680, price:12.25, image:IMAGES.mezze, tags:["lamb","plate","mezze"] },
  { id:"4", name:"Falafel Mezze Box", type:"mezze", region:"Maghreb", spicy:false, vegetarian:true, calories:560, price:9.95, image:IMAGES.mezze, tags:["falafel","mezze","shareable"] },
  { id:"5", name:"Zhoug Salmon Plate", type:"plate", region:"Levant", spicy:true, vegetarian:false, calories:640, price:13.50, image:IMAGES.levant, tags:["fish","zhoug","herbs"] },
];
const SEASONS = [
  { code:"summer-greece", title:"Summer in Greece", story:"Citrus, dill, and extra-virgin olive oil. Sourcing spotlight: Peloponnese co-op.", hero:IMAGES.greece, pairings:["Lemon-dill tzatziki","Iced mint tea"] },
  { code:"autumn-levant", title:"Autumn in the Levant", story:"Sumac, pomegranate, and slow-roasted meats. Sourcing spotlight: Bekaa Valley grains.", hero:IMAGES.levant, pairings:["Pomegranate dressing","Spiced lentil soup"] },
  { code:"winter-maghreb", title:"Winter in the Maghreb", story:"Harissa warmth, roasted roots, preserved lemon.", hero:IMAGES.maghreb, pairings:["Harissa","Couscous"] },
];
const THEMES = {
  terracotta:["#F4A261","#E76F51","#8D4D3A"],
  athens:["#FFB703","#FB8500","#E63946"],
  marrakesh:["#2EC4B6","#00A896","#028090"],
};

/* ---------- State & storage ---------- */
const load = (k,f)=>{ try{const v=localStorage.getItem(k); return v?JSON.parse(v):f;}catch{return f;} };
const save = (k,v)=>{ try{localStorage.setItem(k,JSON.stringify(v));}catch{} };

let prefs = load("prefs",{vegetarian:false,spicy:false,budget:"medium",disliked:[]});
let orders = load("orders",[]);
let points = load("points",0);
let stamps = load("stamps",{Greece:false,Levant:false,Maghreb:false});
let pantry = load("pantry",[]);
let seasonIndex = load("seasonIndex",0);
let theme = load("theme","terracotta");

/* ---------- Helpers ---------- */
function scoreItem(item,prefs,history){
  let s = 0;
  if (prefs.vegetarian && item.vegetarian) s+=2;
  if (!prefs.vegetarian && !item.vegetarian) s+=1;
  if (prefs.spicy === item.spicy) s+=1.5;
  if (prefs.disliked?.some(d=> item.tags.includes(d))) s -= 5;
  if (prefs.budget==="low" && item.price<=10) s+=1.5;
  if (prefs.budget==="medium" && item.price<=12) s+=1.0;
  if (prefs.budget==="high") s+=0.5;
  const times = history.filter(h=>h.id===item.id).length;
  s += times===0 ? 1.2 : Math.max(0, .8 - times*.2);
  return s;
}
function pickTop(){
  return [...MENU].sort((a,b)=> scoreItem(b,prefs,orders)-scoreItem(a,prefs,orders))[0];
}
function fmtPrice(n){ return "$"+n.toFixed(2); }

function labsCountdownISO(iso){
  const t = new Date(iso).getTime(), now=Date.now(), d=Math.max(0,t-now);
  const days=Math.floor(d/86400000), hours=Math.floor((d%86400000)/3600000), mins=Math.floor((d%3600000)/60000);
  return {days,hours,mins};
}
function targetNextWeekISO(){ const dd = new Date(); dd.setDate(dd.getDate()+7); return dd.toISOString(); }

function rollingPIN(ts=Date.now()){
  const slot = Math.floor(ts/20000); // 20s window
  const pin = (slot % 1000000).toString().padStart(6,"0");
  const refresh = 20 - Math.floor((ts/1000) % 20);
  return {pin, refresh};
}
function drawPseudoQR(canvas, seedStr){
  const ctx = canvas.getContext('2d');
  const N = 21; const cell = Math.floor(canvas.width/N);
  ctx.fillStyle = "#0b0f14"; ctx.fillRect(0,0,canvas.width,canvas.height);
  // simple hash
  let h=0; for(let i=0;i<seedStr.length;i++){ h=((h<<5)-h)+seedStr.charCodeAt(i); h|=0; }
  for(let i=0;i<N*N;i++){
    const bit = (h >> (i % 31)) & 1;
    if(bit){
      const x=(i%N)*cell, y=Math.floor(i/N)*cell;
      ctx.fillStyle="#fff"; ctx.fillRect(x+1,y+1,cell-2,cell-2);
    }
  }
}

/* ---------- Theme ---------- */
function applyTheme(name){
  const g = THEMES[name] || THEMES.terracotta;
  document.body.style.backgroundImage =
    `radial-gradient(1200px 800px at 20% -10%, rgba(255,255,255,.08), transparent),
     linear-gradient(135deg, ${g[0]}, ${g[1]}, ${g[2]})`;
  document.getElementById("themeBtn").textContent =
    (name==="terracotta"?"Terracotta":name==="athens"?"Athens":"Marrakesh");
  theme = name; save("theme", theme);
}

/* ---------- UI refs ---------- */
const ptsEl = document.getElementById("points");
const tabs = ["home","season","explore","journey","profile"];
const tabEls = Object.fromEntries(tabs.map(t=>[t,document.getElementById("tab-"+t)]));

/* ---------- Renderers ---------- */
function renderHome(){
  const s = SEASONS[seasonIndex % SEASONS.length];
  document.getElementById("seasonImg").src = s.hero;
  document.getElementById("seasonTitle").textContent = s.title;
  document.getElementById("pairings").textContent = s.pairings.join(" Â· ");

  const pick = pickTop();
  document.getElementById("pickName").textContent = pick.name;
  document.getElementById("pickMeta").textContent = `${pick.region} Â· ${pick.type} Â· ${pick.calories} cal`;
  document.getElementById("pickImg").src = pick.image;
  document.getElementById("pickPrice").textContent = fmtPrice(pick.price);

  // pantry choices
  const choices = ["Hummus","Tzatziki","Pita","Grain Kit"];
  const pc = document.getElementById("pantryChoices"); pc.innerHTML="";
  choices.forEach(x=>{
    const b = document.createElement("button");
    b.className="tag"; b.textContent = "+ "+x;
    b.onclick=()=>{ if(!pantry.includes(x)) { pantry.push(x); save("pantry", pantry); renderPantrySelected(); } };
    pc.appendChild(b);
  });
  renderPantrySelected();
}
function renderPantrySelected(){
  const sel = document.getElementById("pantrySelected");
  sel.textContent = pantry.length ? ("Selected: "+pantry.join(", ")) : "";
}
function renderSeason(){
  const s = SEASONS[seasonIndex % SEASONS.length];
  document.getElementById("seasonImg2").src = s.hero;
  document.getElementById("seasonStory").textContent = s.story;
  document.getElementById("seasonPairs").textContent = s.pairings.join(" Â· ");
}
function renderExplore(){
  const host = document.getElementById("tab-explore");
  host.innerHTML = "";
  MENU.forEach(item=>{
    const card = document.createElement("div"); card.className="card";
    const row = document.createElement("div"); row.className="row";
    const left = document.createElement("div");
    left.innerHTML = `<div style="font-weight:700">${item.name}</div>
                      <div class="muted">${item.region} Â· ${item.type} Â· ${item.calories} cal</div>`;
    const img = document.createElement("img");
    img.src=item.image; img.style="width:90px;height:90px;object-fit:cover;border-radius:14px;border:1px solid var(--glass-border)";
    row.append(left,img);
    const tags = document.createElement("div"); tags.className="tags";
    item.tags.forEach(t=>{
      const sp=document.createElement("span"); sp.className="tag"+(prefs.disliked.includes(t)?" disliked":"");
      sp.textContent="#"+t;
      sp.onclick=()=>{ toggleDisliked(t); renderExplore(); };
      tags.appendChild(sp);
    });
    const foot = document.createElement("div"); foot.className="row"; foot.style="margin-top:8px";
    const price = document.createElement("div"); price.style="color:#bbf7d0;font-weight:700"; price.textContent=fmtPrice(item.price);
    const add = document.createElement("button"); add.className="btn small"; add.textContent="Add";
    add.onclick=()=> placeOrder(item,{pantryAdds:pantry});
    foot.append(price,add);
    card.append(row,tags,foot);
    host.appendChild(card);
  });
}
function renderJourney(){
  document.getElementById("stamp-greece").textContent = stamps.Greece ? "âœ…" : "â¬œ";
  document.getElementById("stamp-levant").textContent = stamps.Levant ? "âœ…" : "â¬œ";
  document.getElementById("stamp-maghreb").textContent = stamps.Maghreb ? "âœ…" : "â¬œ";
}
function renderProfile(){
  document.getElementById("prefVeg").checked = prefs.vegetarian;
  document.getElementById("prefSpicy").checked = prefs.spicy;
  document.getElementById("prefBudget").value = prefs.budget;
  // history
  const ul=document.getElementById("history"); ul.innerHTML="";
  orders.forEach(o=>{
    const li=document.createElement("li");
    li.textContent = `${o.name} â€” ${fmtPrice(o.price)}`;
    ul.appendChild(li);
  });
}
function renderPoints(){ ptsEl.textContent = points+" pts"; }

/* ---------- Actions ---------- */
function toggleDisliked(tag){
  if (prefs.disliked.includes(tag)) prefs.disliked = prefs.disliked.filter(t=>t!==tag);
  else prefs.disliked.push(tag);
  save("prefs",prefs);
}
function placeOrder(item, opts={pantryAdds:[]}){
  orders = [{id:item.id,name:item.name,price:item.price,ts:Date.now(),pantry:opts.pantryAdds}, ...orders];
  save("orders",orders);
  const earned = 10 + (opts.pantryAdds?.length||0)*2;
  points += earned; save("points",points);
  if (stamps[item.region]===false){ stamps[item.region]=true; save("stamps",stamps); }
  alert(`Ordered: ${item.name}  +${earned} pts`);
  renderHome(); renderJourney(); renderProfile(); renderPoints();
}

/* ---------- Tabs ---------- */
document.querySelectorAll(".nav_btn").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    const t = btn.getAttribute("data-tab");
    document.querySelectorAll(".nav_btn").forEach(b=> b.classList.toggle("active", b===btn));
    tabs.forEach(k=> tabEls[k].classList.toggle("hidden", k!==t));
    if(t==="home") renderHome();
    if(t==="season") renderSeason();
    if(t==="explore") renderExplore();
    if(t==="journey") renderJourney();
    if(t==="profile") renderProfile();
  });
});

/* ---------- Event bindings ---------- */
document.getElementById("orderPick").onclick = ()=> placeOrder(pickTop(), {pantryAdds:pantry});
document.getElementById("trySpecial").onclick = ()=> placeOrder(pickTop(), {pantryAdds:pantry});
document.getElementById("goSeason").onclick = ()=> document.querySelector('.nav_btn[data-tab="season"]').click();
document.getElementById("seasonTry").onclick = ()=> placeOrder(pickTop(), {pantryAdds:pantry});
document.getElementById("seasonNext").onclick = ()=>{
  seasonIndex = (seasonIndex+1) % SEASONS.length; save("seasonIndex",seasonIndex); renderSeason(); renderHome();
};
document.getElementById("openPass").onclick = ()=> showPass(true);
document.getElementById("closePass").onclick = ()=> showPass(false);
document.getElementById("copyPIN").onclick = ()=>{
  const t=document.getElementById("pin").textContent.replace(/\s/g,"");
  navigator.clipboard?.writeText(t);
  alert("PIN copied: "+t);
};
document.getElementById("simulateScan").onclick = ()=>{ alert("Scanned âœ“ â€” handoff authorized."); };

document.getElementById("prefVeg").onchange = e=>{ prefs.vegetarian=e.target.checked; save("prefs",prefs); renderHome(); };
document.getElementById("prefSpicy").onchange = e=>{ prefs.spicy=e.target.checked; save("prefs",prefs); renderHome(); };
document.getElementById("prefBudget").onchange = e=>{ prefs.budget=e.target.value; save("prefs",prefs); renderHome(); };
document.getElementById("reset").onclick = ()=>{ localStorage.clear(); location.reload(); };

document.getElementById("themeBtn").onclick = ()=>{
  const cycle = theme==="terracotta" ? "athens" : theme==="athens" ? "marrakesh" : "terracotta";
  applyTheme(cycle);
};

/* ---------- Pickup Pass ---------- */
let passTimer = null;
function showPass(open){
  const ov = document.getElementById("passOverlay");
  ov.classList.toggle("hidden", !open);
  if(open){
    updatePIN();
    passTimer = setInterval(updatePIN, 1000);
  } else if(passTimer){ clearInterval(passTimer); passTimer=null; }
}
function updatePIN(){
  const {pin, refresh} = rollingPIN();
  document.getElementById("pin").textContent = pin.slice(0,3)+" "+pin.slice(3);
  document.getElementById("refresh").textContent = refresh;
  drawPseudoQR(document.getElementById("qr"), pin);
}

/* ---------- Countdown loop ---------- */
const dropISO = targetNextWeekISO();
setInterval(()=>{
  const c = labsCountdownISO(dropISO);
  document.getElementById("countdown").textContent = `${c.days}d ${c.hours}h ${c.mins}m`;
}, 1000);

/* ---------- Initial render ---------- */
applyTheme(theme);
renderHome(); renderSeason(); renderExplore(); renderJourney(); renderProfile(); renderPoints();
</script>
</body>
</html>
